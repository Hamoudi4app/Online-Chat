<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>WebRTC — تبادل يدوي</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2>محادثة WebRTC — تبادل يدوي</h2>

  <button id="startOffer">بدء الاتصال (إنشاء Offer)</button>
  <textarea id="localOffer" readonly></textarea>
  <div id="offerQR"></div>

  <textarea id="remoteOffer" placeholder="ألصق هنا الـ Offer"></textarea>
  <button id="makeAnswer">إنشاء Answer</button>
  <textarea id="localAnswer" readonly></textarea>
  <div id="answerQR"></div>

  <textarea id="remoteAnswer" placeholder="ألصق هنا الـ Answer"></textarea>
  <button id="applyAnswer">تطبيق Answer</button>
  <audio id="remoteAudio" autoplay></audio>

  <script>
    let pc, dataChannel, micStream;
    const localOfferEl = document.getElementById("localOffer");
    const localAnswerEl = document.getElementById("localAnswer");
    const remoteOfferEl = document.getElementById("remoteOffer");
    const remoteAnswerEl = document.getElementById("remoteAnswer");
    const remoteAudio = document.getElementById("remoteAudio");

    document.getElementById("startOffer").onclick = async () => {
      pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      micStream.getTracks().forEach(t=>pc.addTrack(t,micStream));
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      localOfferEl.value = JSON.stringify(pc.localDescription);
      document.getElementById("offerQR").innerHTML = ""; // امسح القديم
      new QRCode(document.getElementById("offerQR"), {
        text: localOfferEl.value,
        width: 200,
        height: 200
      });
    };

    document.getElementById("makeAnswer").onclick = async () => {
      pc = new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
      micStream = await navigator.mediaDevices.getUserMedia({audio:true});
      micStream.getTracks().forEach(t=>pc.addTrack(t,micStream));
      const offerDesc = JSON.parse(remoteOfferEl.value);
      await pc.setRemoteDescription(offerDesc);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      localAnswerEl.value = JSON.stringify(pc.localDescription);
      document.getElementById("answerQR").innerHTML = ""; // امسح القديم
      new QRCode(document.getElementById("answerQR"), {
        text: localAnswerEl.value,
        width: 200,
        height: 200
      });
    };

    document.getElementById("applyAnswer").onclick = async () => {
      const answerDesc = JSON.parse(remoteAnswerEl.value);
      await pc.setRemoteDescription(answerDesc);
    };
  </script>
</body>
</html>
