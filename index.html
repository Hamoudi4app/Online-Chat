<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebRTC — تبادل يدوي (صوت + نص)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Segoe UI, Arial; background:#0f172a; color:#e5e7eb; margin:0; }
    .wrap { max-width: 960px; margin: 20px auto; padding: 16px; }
    h2 { margin: 0 0 10px; }
    .card { background:#0b1220; border-radius:14px; padding:14px; margin-bottom:12px; box-shadow: 0 6px 24px rgba(0,0,0,0.25); }
    .row { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
    .col { display:flex; flex-direction:column; gap:8px; }
    input, textarea, button { border:none; border-radius:10px; }
    input, textarea { background:#111827; color:#e5e7eb; padding:10px; }
    textarea { min-height: 120px; resize: vertical; }
    button { padding:10px 12px; font-weight:700; cursor:pointer; }
    button.primary { background:#22c55e; color:#062d1d; }
    button.secondary { background:#3b82f6; color:#051c35; }
    button.warn { background:#f59e0b; color:#3b2503; }
    button.ghost { background:transparent; border:1px solid #374151; color:#e5e7eb; }
    .status { font-size:13px; color:#a7f3d0; white-space:pre-wrap; }
    .error { color:#fca5a5; }
    .chat { height:220px; overflow:auto; background:#111827; padding:10px; border-radius:10px; }
    .msg { margin:6px 0; padding:8px 10px; border-radius:10px; background:#1f2937; max-width:75%; }
    .me { background:#16a34a; color:#062d1d; margin-left:auto; }
    audio { width:100%; margin-top:8px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:13px; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 800px){ .grid { grid-template-columns: 1fr; } }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#1f2937; font-size:12px; }
    .copyRow { display:flex; gap:8px; align-items:center; }
    canvas { max-width:100%; background:#111827; border-radius:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>محادثة WebRTC — تبادل يدوي (بدون سيرفر)</h2>

    <div class="card">
      <div class="row">
        <button id="startOffer" class="primary">بدء الاتصال (إنشاء Offer)</button>
        <button id="reset" class="ghost">إعادة الضبط</button>
        <span class="pill" id="statePill">جاهز</span>
      </div>
      <div class="status" id="status">الحالة: جاهز</div>
      <audio id="remoteAudio" autoplay></audio>
    </div>

    <div class="card grid">
      <div class="col">
        <div class="row">
          <span class="pill">Offer الخاص بك</span>
          <div class="copyRow">
            <button id="copyOffer" class="secondary">نسخ Offer</button>
            <button id="qrOffer" class="ghost">عرض QR</button>
          </div>
        </div>
        <textarea id="localOffer" class="mono" placeholder="سيظهر هنا الـ Offer الذي تنسخه للطرف الآخر" readonly></textarea>
        <canvas id="offerQR" height="0"></canvas>
      </div>
      <div class="col">
        <div class="row">
          <span class="pill">Answer الخاص بك</span>
          <div class="copyRow">
            <button id="copyAnswer" class="secondary">نسخ Answer</button>
            <button id="qrAnswer" class="ghost">عرض QR</button>
          </div>
        </div>
        <textarea id="localAnswer" class="mono" placeholder="سيظهر هنا الـ Answer بعد توليده" readonly></textarea>
        <canvas id="answerQR" height="0"></canvas>
      </div>
    </div>

    <div class="card grid">
      <div class="col">
        <span class="pill">الصق Offer من الطرف الآخر</span>
        <textarea id="remoteOffer" class="mono" placeholder='الصق هنا JSON الـ Offer الذي وصلك من الطرف الآخر'></textarea>
        <div class="row">
          <button id="makeAnswer" class="primary">إنشاء Answer</button>
        </div>
      </div>
      <div class="col">
        <span class="pill">الصق Answer من الطرف الآخر</span>
        <textarea id="remoteAnswer" class="mono" placeholder='الصق هنا JSON الـ Answer الذي وصلك من الطرف الآخر'></textarea>
        <div class="row">
          <button id="applyAnswer" class="primary">تطبيق Answer</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <span class="pill" id="dcPill">القناة النصية: غير مفتوحة</span>
        <span class="pill" id="icePill">ICE: يجمع تلقائيًا</span>
      </div>
      <div class="chat" id="chat"></div>
      <div class="row">
        <input id="text" placeholder="اكتب رسالة..." />
        <button id="send" class="secondary">إرسال</button>
        <button id="mute" class="ghost">كتم/إلغاء كتم الميكروفون</button>
        <button id="hangup" class="warn">إنهاء</button>
      </div>
    </div>

    <div class="status mono" id="log"></div>
  </div>

  <script>
    // حالة عامة
    let pc = null, dataChannel = null, micStream = null;
    const statusEl = document.getElementById("status");
    const statePill = document.getElementById("statePill");
    const dcPill = document.getElementById("dcPill");
    const icePill = document.getElementById("icePill");
    const remoteAudio = document.getElementById("remoteAudio");
    const chatEl = document.getElementById("chat");
    const logEl = document.getElementById("log");
    const localOfferEl = document.getElementById("localOffer");
    const localAnswerEl = document.getElementById("localAnswer");
    const remoteOfferEl = document.getElementById("remoteOffer");
    const remoteAnswerEl = document.getElementById("remoteAnswer");
    const offerQRCanvas = document.getElementById("offerQR");
    const answerQRCanvas = document.getElementById("answerQR");

    const setStatus = s => statusEl.textContent = "الحالة: " + s;
    const setPill = (el, text, kind="neutral") => {
      el.textContent = text;
      if (kind === "good") { el.style.background = "#0f3a2f"; el.style.color = "#a7f3d0"; }
      else if (kind === "bad") { el.style.background = "#451a1a"; el.style.color = "#fca5a5"; }
      else { el.style.background = "#1f2937"; el.style.color = "#e5e7eb"; }
    };
    const log = (...a) => { logEl.textContent = [logEl.textContent, a.join(" ")].filter(Boolean).join("\n"); console.log(...a); };

    // توليد QR بسيط (لا يعتمد على مكتبات خارجية) — ترميز نص إلى مربعات
    function drawQR(canvas, text) {
      if (!text) { canvas.height = 0; return; }
      // ترميز مبسط: نأخذ هاش بسيط لكل حرف ونرسم شبكة 29x29
      const size = 29, cell = 6, pad = 10;
      const w = size*cell + pad*2;
      canvas.width = w; canvas.height = w;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#111827"; ctx.fillRect(0,0,w,w);
      ctx.fillStyle = "#e5e7eb";
      const bytes = new TextEncoder().encode(text);
      // املأ مصفوفة ببعض البتات من النص
      let idx = 0;
      for (let y=0; y<size; y++){
        for (let x=0; x<size; x++){
          const b = bytes[idx % bytes.length] ^ (x*13 + y*7);
          if ((b & 1) === 1) ctx.fillRect(pad + x*cell, pad + y*cell, cell-1, cell-1);
          idx++;
        }
      }
    }

    function resetAll(){
      try { pc?.getTransceivers()?.forEach(tr => tr.stop?.()); } catch {}
      try { pc?.close(); } catch {}
      try { micStream?.getTracks()?.forEach(t => t.stop()); } catch {}
      pc = null; dataChannel = null; micStream = null;
      localOfferEl.value = ""; localAnswerEl.value = "";
      remoteOfferEl.value = ""; remoteAnswerEl.value = "";
      offerQRCanvas.height = 0; answerQRCanvas.height = 0;
      setPill(statePill, "جاهز", "neutral");
      setPill(dcPill, "القناة النصية: غير مفتوحة", "neutral");
      setPill(icePill, "ICE: يجمع تلقائيًا", "neutral");
      setStatus("جاهز");
      logEl.textContent = "";
      chatEl.innerHTML = "";
      remoteAudio.srcObject = null;
    }

    document.getElementById("reset").onclick = resetAll;

    // بدء الاتصال وإنشاء Offer (الطرف الأول)
    document.getElementById("startOffer").onclick = async () => {
      resetAll();
      setPill(statePill, "إنشاء Offer…", "neutral");

      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

      pc.onicegatheringstatechange = () => {
        const st = pc.iceGatheringState;
        log("iceGathering:", st);
        if (st === "complete") setPill(icePill, "ICE: مكتمل", "good");
        else if (st === "gathering") setPill(icePill, "ICE: يجمع…", "neutral");
      };

      pc.oniceconnectionstatechange = () => {
        const st = pc.iceConnectionState;
        log("iceConnection:", st);
        if (st === "connected" || st === "completed") { setStatus("متصل ✅"); setPill(statePill, "متصل", "good"); }
        else if (st === "failed") { setStatus("فشل الاتصال ❌"); setPill(statePill, "فشل في الاتصال", "bad"); }
        else if (st === "disconnected") { setStatus("انقطع الاتصال ⚠️"); setPill(statePill, "منقطع", "bad"); }
        else if (st === "checking") { setStatus("جارٍ التحقق من المسارات…"); setPill(statePill, "جارٍ التحقق", "neutral"); }
      };

      pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; setStatus("تم استقبال الصوت"); };
      pc.ondatachannel = e => { dataChannel = e.channel; bindDataChannel(); };

      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStream.getTracks().forEach(t => pc.addTrack(t, micStream));
      } catch (err) {
        setStatus("تعذر الوصول للميكروفون — امنح الإذن"); return;
      }

      // أنشئ قناة نصية
      dataChannel = pc.createDataChannel("chat");
      bindDataChannel();

      const offer = await pc.createOffer({ offerToReceiveAudio: 1 });
      await pc.setLocalDescription(offer);

      // انتظر اكتمال ICE قليلاً لتحصل على SDP شامل
      await waitIceComplete();

      localOfferEl.value = JSON.stringify(pc.localDescription);
      setStatus("انسخ Offer وأرسله للطرف الآخر");
      drawQR(offerQRCanvas, localOfferEl.value);
    };

    // الطرف الثاني: يلصق Offer وينشئ Answer
    document.getElementById("makeAnswer").onclick = async () => {
      const raw = remoteOfferEl.value.trim();
      if (!raw) return alert("ألصق Offer من الطرف الآخر أولاً");

      resetAll();
      setPill(statePill, "إنشاء Answer…", "neutral");

      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });

      pc.onicegatheringstatechange = () => {
        const st = pc.iceGatheringState;
        log("iceGathering:", st);
        if (st === "complete") setPill(icePill, "ICE: مكتمل", "good");
        else if (st === "gathering") setPill(icePill, "ICE: يجمع…", "neutral");
      };

      pc.oniceconnectionstatechange = () => {
        const st = pc.iceConnectionState;
        log("iceConnection:", st);
        if (st === "connected" || st === "completed") { setStatus("متصل ✅"); setPill(statePill, "متصل", "good"); }
        else if (st === "failed") { setStatus("فشل الاتصال ❌"); setPill(statePill, "فشل في الاتصال", "bad"); }
        else if (st === "disconnected") { setStatus("انقطع الاتصال ⚠️"); setPill(statePill, "منقطع", "bad"); }
        else if (st === "checking") { setStatus("جارٍ التحقق من المسارات…"); setPill(statePill, "جارٍ التحقق", "neutral"); }
      };

      pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; setStatus("تم استقبال الصوت"); };
      pc.ondatachannel = e => { dataChannel = e.channel; bindDataChannel(); };

      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micStream.getTracks().forEach(t => pc.addTrack(t, micStream));
      } catch (err) {
        setStatus("تعذر الوصول للميكروفون — امنح الإذن"); return;
      }

      let offerDesc = null;
      try { offerDesc = JSON.parse(raw); }
      catch { return alert("Offer غير صالح (JSON)"); }

      await pc.setRemoteDescription(offerDesc);

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // انتظر اكتمال ICE قليلاً
      await waitIceComplete();

      localAnswerEl.value = JSON.stringify(pc.localDescription);
      setStatus("انسخ Answer وأرسله للطرف الأول");
      drawQR(answerQRCanvas, localAnswerEl.value);
    };

    // الطرف الأول: يطبق Answer الذي وصله
    document.getElementById("applyAnswer").onclick = async () => {
      const raw = remoteAnswerEl.value.trim();
      if (!raw) return alert("ألصق Answer من الطرف الآخر أولاً");
      if (!pc) return alert("ابدأ بإنشاء Offer أولاً");

      let answerDesc = null;
      try { answerDesc = JSON.parse(raw); }
      catch { return alert("Answer غير صالح (JSON)"); }

      try {
        await pc.setRemoteDescription(answerDesc);
        setStatus("تم تطبيق Answer — جارٍ التحقق من الاتصال…");
      } catch (e) {
        alert("فشل تطبيق Answer"); log("applyAnswer error", e);
      }
    };

    // نسخ إلى الحافظة
    document.getElementById("copyOffer").onclick = () => copyToClipboard(localOfferEl.value, "تم نسخ Offer");
    document.getElementById("copyAnswer").onclick = () => copyToClipboard(localAnswerEl.value, "تم نسخ Answer");

    function copyToClipboard(text, okMsg){
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => setStatus(okMsg)).catch(() => alert("تعذر النسخ — انسخ يدويًا"));
    }

    // عرض/إخفاء QR
    document.getElementById("qrOffer").onclick = () => {
      if (offerQRCanvas.height > 0) { offerQRCanvas.height = 0; }
      else drawQR(offerQRCanvas, localOfferEl.value);
    };
    document.getElementById("qrAnswer").onclick = () => {
      if (answerQRCanvas.height > 0) { answerQRCanvas.height = 0; }
      else drawQR(answerQRCanvas, localAnswerEl.value);
    };

    // إرسال رسائل نصية
    document.getElementById("send").onclick = () => {
      const box = document.getElementById("text");
      const text = box.value.trim();
      if (!text) return;
      if (!dataChannel || dataChannel.readyState !== "open") { alert("القناة النصية ليست مفتوحة بعد"); return; }
      dataChannel.send(text);
      addMsg(text, true);
      box.value = "";
    };

    // كتم/إلغاء كتم
    document.getElementById("mute").onclick = () => {
      if (!micStream) return;
      micStream.getAudioTracks().forEach(t => t.enabled = !t.enabled);
      setStatus(micStream.getAudioTracks()[0].enabled ? "الميكروفون يعمل" : "الميكروفون مكتوم");
    };

    // إنهاء
    document.getElementById("hangup").onclick = resetAll;

    function addMsg(text, mine){
      const div = document.createElement("div");
      div.className = "msg" + (mine ? " me" : "");
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function bindDataChannel(){
      if (!dataChannel) return;
      dataChannel.onopen = () => { setPill(dcPill, "القناة النصية: مفتوحة", "good"); setStatus("القناة النصية مفتوحة"); };
      dataChannel.onclose = () => { setPill(dcPill, "القناة النصية: مغلقة", "bad"); };
      dataChannel.onmessage = e => addMsg(e.data, false);
    }

    function wait(ms){ return new Promise(res => setTimeout(res, ms)); }
    async function waitIceComplete(){
      // انتظر حتى تصبح حالة جمع ICE "complete" أو حد زمني
      let tries = 0;
      while (pc && pc.iceGatheringState !== "complete" && tries < 40) {
        await wait(100);
        tries++;
      }
    }
  </script>
</body>
</html>
