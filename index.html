<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>غرفة محادثة صوتية + نصية</title>
  <style>
    body{font-family:sans-serif;background:#0f172a;color:#fff;margin:0;padding:20px}
    .card{background:#1f2937;padding:16px;border-radius:10px;margin-bottom:16px}
    input,button{padding:10px;border:none;border-radius:8px;margin:4px 0}
    input{flex:1;background:#111827;color:#fff}
    button{background:#22c55e;color:#062d1d;font-weight:bold;cursor:pointer}
    .chat{height:200px;overflow:auto;background:#111827;padding:10px;border-radius:8px}
    .msg{margin:6px 0;padding:8px;border-radius:6px;background:#3b82f6;color:#fff;max-width:70%}
    .me{background:#16a34a;color:#062d1d;margin-left:auto}
  </style>
</head>
<body>
  <h2>غرفة محادثة صوتية + نصية</h2>

  <div class="card">
    <button id="generate">إنشاء كود غرفة</button>
    <input id="room" placeholder="أدخل كود الغرفة">
    <button id="connect">اتصل</button>
    <button id="hangup">إنهاء</button>
    <p id="status">الحالة: جاهز</p>
    <audio id="remoteAudio" autoplay></audio>
  </div>

  <div class="card">
    <div class="chat" id="chat"></div>
    <input id="text" placeholder="اكتب رسالة...">
    <button id="send">إرسال</button>
  </div>

  <script>
    let ws, pc, dataChannel, micStream;
    const statusEl = document.getElementById("status");
    const remoteAudio = document.getElementById("remoteAudio");
    const chat = document.getElementById("chat");

    function setStatus(s){ statusEl.textContent = "الحالة: " + s; }

    // توليد كود قصير
    document.getElementById("generate").onclick = () => {
      const code = Math.floor(100000 + Math.random()*900000);
      document.getElementById("room").value = code;
      setStatus("تم إنشاء الغرفة بالكود: " + code);
    };

    document.getElementById("connect").onclick = async () => {
      const code = document.getElementById("room").value.trim();
      if(!code) return alert("أدخل كود الغرفة");

      // رابط السيرفر ثابت (لو نشرته على Render أو VPS)
      ws = new WebSocket("wss://YOUR-SIGNALING-SERVER.com"); 

      ws.onopen = () => {
        ws.send(JSON.stringify({ type:"join", code }));
        setStatus("انضممت إلى الغرفة: " + code);
        initRTC(code);
      };

      ws.onmessage = async (evt) => {
        const data = JSON.parse(evt.data);
        if(data.type==="joinedNotice") setStatus(data.msg);
        if(data.type==="signal"){
          const payload = data.payload;
          if(payload.desc){
            await pc.setRemoteDescription(payload.desc);
            if(payload.desc.type==="offer"){
              const answer = await pc.createAnswer();
              await pc.setLocalDescription(answer);
              ws.send(JSON.stringify({ type:"signal", code, payload:{ desc:pc.localDescription } }));
            }
          } else if(payload.candidate){
            try{ await pc.addIceCandidate(payload.candidate); }catch{}
          }
        }
      };
    };

    async function initRTC(code){
      pc = new RTCPeerConnection({ iceServers:[{urls:"stun:stun.l.google.com:19302"}] });
      pc.onicecandidate = e => { if(e.candidate) ws.send(JSON.stringify({ type:"signal", code, payload:{ candidate:e.candidate } })); };
      pc.ontrack = e => remoteAudio.srcObject = e.streams[0];
      pc.ondatachannel = e => { dataChannel = e.channel; dataChannel.onmessage = ev => addMsg(ev.data,false); };

      micStream = await navigator.mediaDevices.getUserMedia({ audio:true });
      micStream.getTracks().forEach(t => pc.addTrack(t, micStream));

      dataChannel = pc.createDataChannel("chat");
      dataChannel.onmessage = ev => addMsg(ev.data,false);

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({ type:"signal", code, payload:{ desc:pc.localDescription } }));
    }

    document.getElementById("send").onclick = () => {
      const text = document.getElementById("text").value.trim();
      if(text && dataChannel && dataChannel.readyState==="open"){
        dataChannel.send(text);
        addMsg(text,true);
      }
    };

    function addMsg(text,mine){
      const div=document.createElement("div");
      div.className="msg"+(mine?" me":"");
      div.textContent=text;
      chat.appendChild(div);
    }

    document.getElementById("hangup").onclick = () => {
      pc.close(); ws.close(); setStatus("تم إنهاء الاتصال");
    };
  </script>
</body>
</html>
