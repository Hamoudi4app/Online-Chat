<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebRTC — تبادل يدوي (صوت + نص)</title>
  <style>
    body { font-family: system-ui, Arial; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
    h2 { margin-bottom:10px; }
    .card { background:#0b1220; border-radius:14px; padding:14px; margin-bottom:12px; }
    textarea { width:100%; min-height:120px; background:#111827; color:#e5e7eb; border:none; border-radius:10px; padding:10px; font-family: monospace; }
    button { padding:10px 12px; border:none; border-radius:10px; cursor:pointer; margin:4px 0; }
    button.primary { background:#22c55e; color:#062d1d; font-weight:bold; }
    button.secondary { background:#3b82f6; color:#051c35; font-weight:bold; }
    .chat { height:200px; overflow:auto; background:#111827; padding:10px; border-radius:10px; margin-top:10px; }
    .msg { margin:6px 0; padding:8px; border-radius:10px; background:#1f2937; max-width:70%; }
    .me { background:#16a34a; color:#062d1d; margin-left:auto; }
    audio { width:100%; margin-top:10px; }
    .qr { margin-top:10px; }
  </style>
</head>
<body>
  <h2>محادثة WebRTC — تبادل يدوي</h2>

  <div class="card">
    <button id="startOffer" class="primary">بدء الاتصال (إنشاء Offer)</button>
    <textarea id="localOffer" placeholder="سيظهر هنا الـ Offer" readonly></textarea>
    <div id="offerQR" class="qr"></div>
  </div>

  <div class="card">
    <textarea id="remoteOffer" placeholder="ألصق هنا الـ Offer من الطرف الآخر"></textarea>
    <button id="makeAnswer" class="secondary">إنشاء Answer</button>
    <textarea id="localAnswer" placeholder="سيظهر هنا الـ Answer" readonly></textarea>
    <div id="answerQR" class="qr"></div>
  </div>

  <div class="card">
    <textarea id="remoteAnswer" placeholder="ألصق هنا الـ Answer من الطرف الآخر"></textarea>
    <button id="applyAnswer" class="primary">تطبيق Answer</button>
    <audio id="remoteAudio" autoplay></audio>
  </div>

  <div class="card">
    <div class="chat" id="chat"></div>
    <input id="text" placeholder="اكتب رسالة..." />
    <button id="send" class="secondary">إرسال</button>
  </div>

  <!-- مكتبة QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    let pc, dataChannel, micStream;
    const localOfferEl = document.getElementById("localOffer");
    const localAnswerEl = document.getElementById("localAnswer");
    const remoteOfferEl = document.getElementById("remoteOffer");
    const remoteAnswerEl = document.getElementById("remoteAnswer");
    const remoteAudio = document.getElementById("remoteAudio");
    const chatEl = document.getElementById("chat");

    function addMsg(text, mine){
      const div=document.createElement("div");
      div.className="msg"+(mine?" me":"");
      div.textContent=text;
      chatEl.appendChild(div);
      chatEl.scrollTop=chatEl.scrollHeight;
    }

    function bindDataChannel(){
      if(!dataChannel) return;
      dataChannel.onopen=()=>addMsg("✅ القناة النصية مفتوحة",false);
      dataChannel.onmessage=e=>addMsg(e.data,false);
    }

    document.getElementById("startOffer").onclick=async()=>{
      pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
      pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
      pc.ondatachannel=e=>{dataChannel=e.channel;bindDataChannel();};
      micStream=await navigator.mediaDevices.getUserMedia({audio:true});
      micStream.getTracks().forEach(t=>pc.addTrack(t,micStream));
      dataChannel=pc.createDataChannel("chat");
      bindDataChannel();
      const offer=await pc.createOffer();
      await pc.setLocalDescription(offer);
      localOfferEl.value=JSON.stringify(pc.localDescription);
      new QRCode(document.getElementById("offerQR"),{text:localOfferEl.value,width:200,height:200});
    };

    document.getElementById("makeAnswer").onclick=async()=>{
      pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
      pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
      pc.ondatachannel=e=>{dataChannel=e.channel;bindDataChannel();};
      micStream=await navigator.mediaDevices.getUserMedia({audio:true});
      micStream.getTracks().forEach(t=>pc.addTrack(t,micStream));
      const offerDesc=JSON.parse(remoteOfferEl.value);
      await pc.setRemoteDescription(offerDesc);
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      localAnswerEl.value=JSON.stringify(pc.localDescription);
      new QRCode(document.getElementById("answerQR"),{text:localAnswerEl.value,width:200,height:200});
    };

    document.getElementById("applyAnswer").onclick=async()=>{
      const answerDesc=JSON.parse(remoteAnswerEl.value);
      await pc.setRemoteDescription(answerDesc);
    };

    document.getElementById("send").onclick=()=>{
      const text=document.getElementById("text").value.trim();
      if(text && dataChannel && dataChannel.readyState==="open"){
        dataChannel.send(text);
        addMsg(text,true);
        document.getElementById("text").value="";
      }
    };
  </script>
</body>
</html>
