<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>WebRTC â€” ØºØ±Ù ÙˆØ±ÙˆØ§Ø¨Ø· Ù‚ØµÙŠØ±Ø©</title>
  <style>
    body { font-family: system-ui, Arial; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
    h2 { margin-bottom:10px; }
    .card { background:#1f2937; border-radius:14px; padding:14px; margin-bottom:16px; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
    input, textarea { width:100%; background:#111827; color:#e5e7eb; border:none; border-radius:10px; padding:10px; margin-top:8px; }
    button { padding:10px 12px; border:none; border-radius:10px; cursor:pointer; margin:4px 0; font-weight:bold; }
    button.primary { background:#22c55e; color:#062d1d; }
    button.secondary { background:#3b82f6; color:#051c35; }
    .chat { height:200px; overflow:auto; background:#111827; padding:10px; border-radius:10px; margin-top:10px; }
    .msg { margin:6px 0; padding:8px; border-radius:10px; background:#374151; max-width:70%; }
    .me { background:#16a34a; color:#062d1d; margin-left:auto; }
    audio { width:100%; margin-top:10px; }
    .qr { margin-top:10px; text-align:center; }
  </style>
  <!-- Ù…ÙƒØªØ¨Ø© QRCode.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <h2>Ù…Ø­Ø§Ø¯Ø«Ø© WebRTC â€” Ø±ÙˆØ§Ø¨Ø· Ù‚ØµÙŠØ±Ø© + QR</h2>

  <div class="card">
    <button id="createRoom" class="primary">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
    <input id="roomLink" readonly placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§" />
    <div id="roomQR" class="qr"></div>
  </div>

  <div class="card">
    <input id="joinRoom" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø§Ù…Ø³Ø­ QR" />
    <button id="connect" class="secondary">Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØºØ±ÙØ©</button>
    <audio id="remoteAudio" autoplay></audio>
  </div>

  <div class="card">
    <div class="chat" id="chat"></div>
    <input id="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
    <button id="send" class="secondary">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>

  <script>
    let pc, dataChannel, micStream;
    const chatEl=document.getElementById("chat");
    const remoteAudio=document.getElementById("remoteAudio");

    function addMsg(text,mine){
      const div=document.createElement("div");
      div.className="msg"+(mine?" me":"");
      div.textContent=text;
      chatEl.appendChild(div);
      chatEl.scrollTop=chatEl.scrollHeight;
    }

    function bindDataChannel(){
      if(!dataChannel) return;
      dataChannel.onopen=()=>addMsg("âœ… Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ù†ØµÙŠØ© Ù…ÙØªÙˆØ­Ø©",false);
      dataChannel.onmessage=e=>addMsg(e.data,false);
    }

    // Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
    document.getElementById("createRoom").onclick=()=>{
      const roomId=Math.random().toString(36).substring(2,8); // ÙƒÙˆØ¯ Ù‚ØµÙŠØ±
      const link=location.origin+"/room/"+roomId;
      document.getElementById("roomLink").value=link;
      document.getElementById("roomQR").innerHTML="";
      new QRCode(document.getElementById("roomQR"),{text:link,width:200,height:200});
    };

    // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„ØºØ±ÙØ©
    document.getElementById("connect").onclick=async()=>{
      const link=document.getElementById("joinRoom").value.trim();
      if(!link){alert("âš ï¸ Ø£Ø¯Ø®Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØºØ±ÙØ© Ø£Ùˆ Ø§Ù…Ø³Ø­ QR");return;}
      // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ ÙƒÙˆØ¯ WebRTC Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ø¹ Ø³ÙŠØ±ÙØ± Ø¥Ø´Ø§Ø±Ø§Øª
      pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
      pc.ontrack=e=>remoteAudio.srcObject=e.streams[0];
      pc.ondatachannel=e=>{dataChannel=e.channel;bindDataChannel();};
      micStream=await navigator.mediaDevices.getUserMedia({audio:true});
      micStream.getTracks().forEach(t=>pc.addTrack(t,micStream));
      dataChannel=pc.createDataChannel("chat");
      bindDataChannel();
      addMsg("ğŸ“¡ ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ Ø§Ù„ØºØ±ÙØ©: "+link,false);
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
    document.getElementById("send").onclick=()=>{
      const text=document.getElementById("text").value.trim();
      if(text && dataChannel && dataChannel.readyState==="open"){
        dataChannel.send(text);
        addMsg(text,true);
        document.getElementById("text").value="";
      }
    };
  </script>
</body>
</html>
